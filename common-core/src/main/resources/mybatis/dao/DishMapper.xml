<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.disagreed.independentrepo.repository.mybatis.DishMapper">

    <resultMap id="Dish" type="DishEntity" autoMapping="true">
        <id property="dishId" column="dish_id"/>
        <association property="qualification" column="qualification_id"
                     javaType="QualificationEntity" autoMapping="true" columnPrefix="q_">
            <id property="qualificationId" column="qualification_id"/>
        </association>
        <collection property="ingredients"
                    ofType="IngredientEntity" autoMapping="true" columnPrefix="ing_">
            <id property="ingredientId" column="ingredient_id"/>
            <association property="manufacturer" column="manufacturer_id"
                         javaType="ManufacturerEntity" autoMapping="true" columnPrefix="mf_">
                <id property="manufacturerId" column="manufacturer_id"/>
                <association property="city" column="city_id"
                             javaType="CityEntity" autoMapping="true" columnPrefix="ci_">
                    <id property="cityId" column="city_id"/>
                    <association property="country" column="country_id"
                                 javaType="CountryEntity" autoMapping="true" columnPrefix="co_">
                        <id property="countryId" column="country_id"/>
                    </association>
                </association>
                <association property="person" column="person_id"
                             javaType="PersonEntity" autoMapping="true" columnPrefix="p_">
                    <id property="personId" column="person_id"/>
                </association>
            </association>
        </collection>
    </resultMap>

    <sql id="AliasBaseDishColumns">
        ${alias}.dish_id as ${prefix}dish_id,
        ${alias}.name as ${prefix}name,
        ${alias}.price as ${prefix}price,
        ${alias}.description as ${prefix}description,
        ${alias}.image as ${prefix}image,

        <include refid="com.disagreed.independentrepo.repository.mybatis.QualificationMapper.AliasBaseQualificationColumns">
            <property name="alias" value="q"/>
            <property name="prefix" value="q_"/>
        </include>
        ,
        <include refid="com.disagreed.independentrepo.repository.mybatis.IngredientMapper.AliasBaseIngredientColumns">
            <property name="alias" value="ing"/>
            <property name="prefix" value="ing_"/>
        </include>
        ,
        <include refid="com.disagreed.independentrepo.repository.mybatis.ManufacturerMapper.AliasBaseManufacturerColumns">
            <property name="alias" value="mf"/>
            <property name="prefix" value="ing_mf_"/>
        </include>
        ,
        <include refid="com.disagreed.independentrepo.repository.mybatis.PersonMapper.AliasBasePersonColumns">
            <property name="alias" value="p"/>
            <property name="prefix" value="ing_mf_p_"/>
        </include>
        ,
        <include refid="com.disagreed.independentrepo.repository.mybatis.CityMapper.AliasBaseCityColumns">
            <property name="alias" value="ci"/>
            <property name="prefix" value="ing_mf_ci_"/>
        </include>
        ,
        <include refid="com.disagreed.independentrepo.repository.mybatis.CountryMapper.AliasBaseCountryColumns">
            <property name="alias" value="co"/>
            <property name="prefix" value="ing_mf_ci_co_"/>
        </include>
    </sql>

    <sql id="BaseDishColumns">
        <include refid="AliasBaseDishColumns">
            <property name="alias" value="ds"/>
            <property name="prefix" value=""/>
        </include>
    </sql>

    <sql id="DishJoin">

        inner join qualification q on ds.qualification_id = q.qualification_id
        left join ingredient ing on ing.dish_id = ds.dish_id
        inner join manufacturer mf on mf.manufacturer_id = ing.manufacturer_id
        inner join city ci on ci.city_id = mf.city_id
        inner join person p on p.person_id = mf.person_id
        inner join country co on co.country_id = ci.country_id and co.action_ind != 'D'
    </sql>

    <select id="getByDishId" resultMap="Dish">
        select
        <include refid="BaseDishColumns"/>
        from dish ds
        <include refid="DishJoin"/>
        where ds.dish_id = #{dishId}
    </select>

    <select id="getAll" resultMap="Dish">
        select
        <include refid="BaseDishColumns"/>
        from dish ds
        <include refid="DishJoin"/>
    </select>
</mapper>