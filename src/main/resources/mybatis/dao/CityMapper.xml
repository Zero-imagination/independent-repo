<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.disagreed.independentrepo.repository.mybatis.CityMapper">

    <resultMap id="City" type="CityEntity" autoMapping="true">
        <association property="country" column="country_id"
                     javaType="CountryEntity" autoMapping="true" columnPrefix="co_">
            <id property="countryId" column="country_id"/>
        </association>
    </resultMap>

    <sql id="BaseCityColumns">
        ci.city_id,
        ci.name,
        ci.is_capital,
        ci.area,
        ci.population,
        ci.density,
        ci.coordinates,
        co.country_id co_country_id,
        co.name co_name,
        co.national_language co_national_language,
        co.area co_area,
        co.population co_population,
        co.density co_density,
        co.coordinates co_coordinates
    </sql>
    
    <sql id="CityJoin">
        inner join country co on co.country_id = ci.country_id and co.action_ind != 'D'
    </sql>

    <select id="getByCityId" resultMap="City">
        select 
        <include refid="BaseCityColumns"/>
        from city ci
        <include refid="CityJoin"/>
        where city_id =#{cityId}
            and ci.action_ind != 'D'
    </select>

    <select id="getByName" resultMap="City">
        select
        <include refid="BaseCityColumns"/>
        from city ci
        <include refid="CityJoin"/>
        where ci.name = #{name}
            and ci.action_ind != 'D'
    </select>

    <select id="getAll" resultMap="City">
        select
        <include refid="BaseCityColumns"/>
        from city ci
        <include refid="CityJoin"/>
        where ci.action_ind != 'D'
    </select>

    <select id="getAllByCountryIds" parameterType="collection" resultMap="City">
        select
        <include refid="BaseCityColumns"/>
        from city ci
        <include refid="CityJoin"/>
        where co.country_id in
            <foreach collection="countryIds" open="(" item="id" separator="," close=")">
                #{id}
            </foreach>
            and ci.action_ind != 'D'
    </select>
    
    <insert id="saveAll" parameterType="CityEntity" keyProperty="cities.cityId">
        insert into city
        (name, is_capital, area, population, density, coordinates, country_id)
        values
        <foreach collection="cities" item="city" separator=",">
            (#{city.name}, #{city.isCapital}, #{city.area}, #{city.population},
            #{city.density}, #{city.coordinates}, #{city.country.countryId})
        </foreach>
    </insert>

    <update id="updateAll" parameterType="CityEntity" keyProperty="cities.cityId">
        update city as c
        set
        name = new.name,
        is_capital = new.isCapital,
        area = new.area,
        population = new.population,
        density = new.density,
        coordinates = new.coordinates,
        country_id =  new.countryId,
        modify_dttm = now(),
        action_ind = 'U'
        from
        <foreach collection="cities" item="city" open='(VALUES' separator=',' close=')'>
            (#{city.cityId,jdbcType=BIGINT}, #{city.name,jdbcType=VARCHAR}, #{city.isCapital,jdbcType=BOOLEAN},
                #{city.area,jdbcType=BIGINT}, #{city.population,jdbcType=BIGINT}, #{city.density,jdbcType=REAL},
                #{city.coordinates,jdbcType=VARCHAR}, #{city.country.countryId,jdbcType=BIGINT})
        </foreach>
        as new(cityId, name, isCapital, area, population, density, coordinates, countryId)
        where c.city_id = new.cityId
            and action_ind != 'D'
    </update>

    <update id="markDeleteAll" parameterType="CityEntity" keyProperty="cities.cityId">
        <if test="ids != null and ids.size() != 0">
            update city set
            action_ind = 'D'
            where city_id
            in (<foreach collection="ids" item="id" separator=",">
            #{id}
        </foreach>);
        </if>
    </update>
</mapper>
